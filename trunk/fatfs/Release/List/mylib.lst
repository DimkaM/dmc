###############################################################################
#                                                                             #
#     IAR Systems Z80/64180 Assembler V4.06A/WIN 11/Jan/2012  15:47:51        #
#     Copyright 2001 IAR Systems. All rights reserved.                        #
#                                                                             #
#           Target option =  z80                                              #
#           Source file   =  I:\zx\projects\fatfs\mylib.asm                   #
#           List file     =  I:\zx\projects\fatfs\Release\List\mylib.lst      #
#           Object file   =  I:\zx\projects\fatfs\Release\Obj\mylib.r01       #
#           Command line  =  -v0 -uu -OI:\zx\projects\fatfs\Release\Obj\ -s+  #
#                            -M<> -w+ -LI:\zx\projects\fatfs\Release\List\    #
#                            -T -t8 -IC:\Program Files\IAR ewz80\z80\inc\     #
#                            I:\zx\projects\fatfs\mylib.asm                   #
#                                                                             #
###############################################################################

      1    000000          MODULE mylib
      2    000000            PUBLIC tablcall
      3    000000            PUBLIC LD_CLUST
      4    000000            PUBLIC get_fattime
      5    000000            EXTERN f_mount
      6    000000            EXTERN f_open
      7    000000            EXTERN f_read
      8    000000            EXTERN f_lseek
      9    000000            EXTERN f_close
     10    000000            EXTERN f_opendir
     11    000000            EXTERN f_readdir
     12    000000            EXTERN f_stat
     13    000000            EXTERN f_write
     14    000000            EXTERN f_getfree
     15    000000            EXTERN f_truncate
     16    000000            EXTERN f_sync
     17    000000            EXTERN f_unlink
     18    000000            EXTERN f_mkdir
     19    000000            EXTERN f_chmod
     20    000000            EXTERN f_utime
     21    000000            EXTERN f_rename
     22    000000            EXTERN f_chdrive
     23    000000            EXTERN f_chdir
     24    000000            EXTERN ?L_MUL_L03
     25    000000            
     26    000000            RSEG NEAR_Z
     27    000000          
     28    000000            RSEG RCODE
     29    000000          tablcall:  
     30    000000 ....       DEFW f_mount
     31    000002 ....       DEFW f_open
     32    000004 ....       DEFW f_read
     33    000006 ....       DEFW f_lseek
     34    000008 ....       DEFW f_close
     35    00000A ....       DEFW f_opendir
     36    00000C ....       DEFW f_readdir
     37    00000E ....       DEFW f_stat
     38    000010 ....       DEFW f_write
     39    000012 ....       DEFW f_getfree
     40    000014 ....       DEFW f_truncate
     41    000016 ....       DEFW f_sync
     42    000018 ....       DEFW f_unlink
     43    00001A ....       DEFW f_mkdir
     44    00001C ....       DEFW f_chmod
     45    00001E ....       DEFW f_utime
     46    000020 ....       DEFW f_rename
     47    000022 ....       DEFW f_chdrive
     48    000024 ....       DEFW f_chdir
     49    000026          //VolToPart:
     50    000026          //        DEFB 0,0,1,0
     51    000026 ....       DEFW ?L_MUL_L03 
     52    000028          
     53    000028          LD_CLUST:
     54    000028 211400     LD HL,20
     55    00002B 19         ADD HL,DE
     56    00002C 4E         LD C,(HL)
     57    00002D 23         INC HL
     58    00002E 46         LD B,(HL)
     59    00002F 211A00     LD HL,26
     60    000032 19         ADD HL,DE
     61    000033 7E         LD A,(HL)
     62    000034 23         INC HL
     63    000035 66         LD H,(HL)
     64    000036 6F         LD L,A
     65    000037 C9         ret
     66    000038            
     67    000038              
     68    000038          minmes    
     69    000038 57           ld d,a
     70    000039 AF           xor a
     71    00003A CB3A         srl d
     72    00003C CB1F         rr a
     73    00003E CB3A         srl d
     74    000040 CB1F         rr a
     75    000042 CB3A         srl d
     76    000044 CB1F         rr a
     77    000046 86           add a,(hl)
     78    000047 77           ld (hl),a
     79    000048 23           inc hl
     80    000049 72           ld (hl),d
     81    00004A C9           ret
     82    00004B          bcd2bin
     83    00004B 06DF         ld b,0xdf
     84    00004D ED79         out (c),a
     85    00004F 06BF         ld b,0xbf
     86    000051 ED78         in a,(c)
     87    000053 C9           ret
     88    000054              
     89    000054          get_fattime:
     90    000054 C5           push bc
     91    000055 D5           push de
     92    000056 EB           ex de,hl
     93    000057 01BE0B       ld bc,0x0bbe
     94    00005A ED78         in a,(c)
     95    00005C 01F7EF       ld bc,0xeff7
     96    00005F F680         or 0x80
     97    000061 ED79         out (c),a
     98    000063 3E0B         ld a,0x0b
     99    000065 06DF         ld b,0xdf
    100    000067 ED79         out (c),a
    101    000069 06BF         ld b,0xbf
    102    00006B ED78         in a,(c)
    103    00006D F604         or 0x04
    104    00006F ED79         out (c),a
    105    000071 AF           xor a               //sec
    106    000072 CD....       call bcd2bin
    107    000075 CB3F         srl a
    108    000077 77           ld (hl),a
    109    000078              
    110    000078 3E02         ld a,2              //min
    111    00007A CD....       call bcd2bin
    112    00007D CD....       call minmes
    113    000080              
    114    000080 3E04         ld a,4              //h
    115    000082 CD....       call bcd2bin
    116    000085 CB27         sla a
    117    000087 CB27         sla a
    118    000089 CB27         sla a
    119    00008B 86           add a,(hl)
    120    00008C 77           ld (hl),a
    121    00008D              
    122    00008D 3E07         ld a,7              //day
    123    00008F CD....       call bcd2bin
    124    000092 23           inc hl
    125    000093 77           ld (hl),a
    126    000094              
    127    000094 3E08         ld a,8              //mes
    128    000096 CD....       call bcd2bin
    129    000099 CD....       call minmes
    130    00009C              
    131    00009C 3E09         ld a,9              //god
    132    00009E CD....       call bcd2bin
    133    0000A1 C614         add a,20
    134    0000A3 CB27         sla a
    135    0000A5 86           add a,(hl)
    136    0000A6 77           ld (hl),a 
    137    0000A7 01BE0B       ld bc,0x0bbe
    138    0000AA ED78         in a,(c)
    139    0000AC 01F7EF       ld bc,0xeff7
    140    0000AF EE80         xor 0x80
    141    0000B1 ED79         out (c),a
    142    0000B3 D1           pop de
    143    0000B4 C1           pop bc
    144    0000B5 C9           ret
    145    0000B6          
    146    0000B6          
    147    0000B6          ENDMOD
##############################
#          CRC:BD04          #
#        Errors:   0         #
#        Warnings: 0         #
#         Bytes: 182         #
##############################



##############################
#          CRC:BD04          #
#        Errors:   0         #
#        Warnings: 0         #
#         Bytes: 182         #
##############################



